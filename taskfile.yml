version: '3'

dotenv:
  - .env

tasks:
  default:
    aliases: [list]
    silent: true
    desc: "List all available tasks"
    cmds:
      - task --list-all

  backend:build:
    silent: true
    desc: "Build executable for backend"
    cmds: [go build -o ./tmp/backend ./backend]

  backend:run:
    silent: true
    desc: "Run the Go server locally"
    cmds: [go run ./backend]

  backend:dev:
    dir: .
    silent: true
    aliases: [backend, air]
    desc: "Run the Go server with development mode"
    cmds: [air]

  compose:up:
    silent: true
    aliases: [up]
    desc: "Start Docker Compose stack with build"
    cmds:
      - docker compose up --build

  compose:down:
    silent: true
    aliases: [down]
    desc: "Stop Docker Compose stack and remove orphan containers"
    cmds:
      - docker compose down --remove-orphans

  docs:
    silent: true
    desc: "Serve local documentation site"
    cmds: [uv run zensical serve]
  
  clean:
    silent: true
    cmds: [rm -rf site .venv tmp]
  
  encrypt:
    silent: true
    desc: "Encrypt .env and terraform.tfvars files"
    cmds: [sops -e -i .env, sops -e -i terraform/environments/terraform.tfvars]

  decrypt:
    silent: true
    desc: "Decrypt .env and terraform.tfvars files"
    cmds: [sops -d -i .env, sops -d -i terraform/environments/terraform.tfvars]

  tf:plan:
    silent: true
    desc: "Generate Terraform/OpenTofu plan for the environment"
    dir: terraform/environments
    cmds: [tofu plan]

  tf:apply:
    silent: true
    var:
      approve: false
    dir: terraform/environments
    desc: "Apply Terraform/OpenTofu plan to the environment"
    cmds: 
      - tofu apply
  
  tf:apply:auto:
    silent: true
    dir: terraform/environments
    desc: "Apply Terraform/OpenTofu plan (auto approve)"
    cmds:
      - tofu apply --auto-approve
  
  tf:unlock:
    silent: true
    dir: terraform/environments
    var:
      ID: 
    desc: "Apply Terraform/OpenTofu plan (auto approve)"
    cmds:
      - tofu force-unlock {{.ID}}

  tf:destroy:
    silent: true
    dir: terraform/environments
    desc: "Destroy Terraform/OpenTofu managed infrastructure"
    cmds: [tofu destroy]

  tf:validate:
    silent: true
    dir: terraform/environments
    desc: "Validate Terraform/OpenTofu configuration"
    cmds: [tofu validate]

  tf:output:
    silent: true
    dir: terraform/environments
    desc: "Initialize Terraform/OpenTofu with remote backend"
    cmds: [tofu output]
  
  tf:init:
    silent: true
    dir: terraform/environments
    desc: "Initialize Terraform/OpenTofu with remote backend"
    cmds: 
    - |
      tofu init \
      -backend-config="address=https://gitlab.com/api/v4/projects/$GITLAB_PROJECT_ID/terraform/state/$TF_STATE_NAME" \
      -backend-config="lock_address=https://gitlab.com/api/v4/projects/$GITLAB_PROJECT_ID/terraform/state/$TF_STATE_NAME/lock" \
      -backend-config="unlock_address=https://gitlab.com/api/v4/projects/$GITLAB_PROJECT_ID/terraform/state/$TF_STATE_NAME/lock" \
      -backend-config="username=$GITLAB_USERNAME" \
      -backend-config="password=$GITLAB_ACCESS_TOKEN" \
      -backend-config="lock_method=POST" \
      -backend-config="unlock_method=DELETE" \
      -backend-config="retry_wait_min=5"
        
  swagger:init:
    desc: Generate Swagger documation of Gen Service
    cmds:
      - |
        swag init \
        --parseInternal \
        --packageName swagger \
        --dir ./backend/server \
        -g ../main.go \
        -o ./backend/swagger

  work:sync:
    cmds: 
      - cd libs/core && go mod tidy
      - cd libs/idp && go mod tidy
      - cd libs/logger && go mod tidy
      - cd libs/queue && go mod tidy
      - cd libs/storage && go mod tidy
      - cd backend && go mod tidy
      - cd consumer && go mod tidy

